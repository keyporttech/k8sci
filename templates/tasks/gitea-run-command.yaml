{{- $fullName := include "k8sCI.fullname" . -}}

apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: {{ include "k8sCI.fullname" . }}-run-command-gitea
  labels:
    {{- include "k8sCI.labels" . | nindent 4 }}
spec:
  resources:
    inputs:
    - name: git-repo
      type: git
  params:
    - name: org
    - name: repo
    - name: git_sha
    - name: ref
    - name: image
    - name: commands
    - name: htmlurl
  results:
    - name: status
    - name: description
    - name: output
  steps:
    - name: run
      image: "$(params.image)"
      workingDir: "/workspace/git-repo"
      securityContext:
        privileged: true
      env:
      {{- range .Values.pipelineEnvSecrets }}
      - name: {{ .name }}
        valueFrom:
          secretKeyRef:
            name: {{ $fullName }}
            key: {{ .name }}
      {{- end }}
      - name: COMMANDS
        value: "$(params.commands)"
      command:
        - "bash"
      args:
        - "-cx"
        - |
          ALL_OUTPUT="";
          set +e;
          RESULT=0
          for command in "${COMMANDS[@]}"
          do
             :
             exec 3>&1
             output=$($command 2>&1 1>&3);
             exec 3>&-
             RESULT=$?;
             ALL_OUTPUT="${ALL_OUTPUT}
             ${output}"
             [ $RESULT -ne 0 ] && echo "failure" > /tekton/home/status; break
          done
          [ $RESULT -eq 0 ]  echo "success" > /tekton/home/status;
          [ $RESULT -eq 0 ] && echo "build succeeded." > /tekton/home/description || echo "build failed." > /tekton/home/description;
          echo $ALL_OUTPUT > /tekton/home/output;
          exit 0;
      volumeMounts:
      - mountPath: /tekton/home
        name: home
      - mountPath: /var/lib/docker
        name: dind-storage
      - mountPath: /var/run/
        name: dind-socket
    - name: post-commit-status-gitea
      image: "$(params.image)"
      env:
      {{- range .Values.pipelineEnvSecrets }}
      - name: {{ .name }}
        valueFrom:
          secretKeyRef:
            name: {{ $fullName }}
            key: {{ .name }}
      {{- end }}
      command:
        - "bash"
      args:
        - "-cx"
        - |
          # pending,success,error,failure,warning
          curl -X POST {{ .Values.gitSources.gitea.apiEndPoint}}/repos/$(params.org)/$(params.repo)/statuses/$(params.git_sha) \
          -H "accept: application/json" \
          -H "Authorization: token ${GITEA_TOKEN}" \
          -H "Content-Type: application/json" -i -k -d "{\
            \"context\": \"k8sCI\",\
            \"description\": \"$(cat /tekton/home/description)\",\
            \"state\": \"$(cat /tekton/home/status)\",\
            \"target_url\": \"{{ .Values.ingress.host }}/dashboard\"\
          }"
      volumeMounts:
      - mountPath: /tekton/home
        name: home
    {{- if .Values.notifications.slackWebhook }}
    - name: slack-notify
      image: "technosophos/slack-notify"
      env:
        - name: SLACK_WEBHOOK
          value: {{ .Values.notifications.slackWebhook }}
        - name: SLACK_USERNAME
          value: "{{ $fullName }}"
        - name: PIPELINERUN_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
      workingDir: "/workspace/git-repo"
      command:
        - "bash"
      args:
        - "-cx"
        - |
          export STATUS=$(cat /tekton/home/status);
          [ "$STATUS" != "success" ] && export SYMBOL=":no_entry:" || export SYMBOL=":thumbsup:";
          export SLACK_TITLE="${SYMBOL} gitea $(params.org)/$(params.repo) $(params.htmlurl) : ${STATUS} {{ .Values.ingress.dashboardURL }}/#/namespaces/cicd/pipelineruns/${PIPELINERUN_NAME}";
          export SLACK_MESSAGE="${STATUS}";
          [ "$STATUS" != "success" ] && export SLACK_MESSAGE="build output:
          $(cat /tekton/home/output)";
          [ "$STATUS" != "success" ] && export SLACK_COLOR="danger" || export SLACK_COLOR="success";
          /slack-notify;
      volumeMounts:
      - mountPath: /tekton/home
        name: home
      {{- end }}
  sidecars:
  - image: docker:18.05-dind
    name: server
    securityContext:
      privileged: true
    volumeMounts:
      - mountPath: /var/lib/docker
        name: dind-storage
      - mountPath: /var/run/
        name: dind-socket
  volumes:
    - name: home
      emptyDir: {}
    - name: dind-storage
      emptyDir: {}
    - name: dind-socket
      emptyDir: {}
